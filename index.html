<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Memory Therapists</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif:wght@300;400;700&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #E94560;
            --secondary-color: #48cae4;
            --background-start: #0a0a10;
            --text-color: #e0e0e0;
            --text-muted: #8a8a9e;
            --panel-bg: rgba(10, 10, 20, 0.65);
            --panel-border: rgba(233, 69, 96, 0.2);
            --font-title: 'Orbitron', sans-serif;
            --font-body: 'Noto Serif', serif;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: var(--font-body);
            background-image: linear-gradient(rgba(10, 10, 16, 0.5), rgba(26, 26, 46, 0.5)), url('/shop.png');
            background-color: var(--background-start);
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background-size: cover;
            background-attachment: fixed;
            background-position: center right;
            transition: background-image 1s ease-in-out;
        }
        .container {
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
            text-align: center;
            backdrop-filter: blur(8px);
            border: 1px solid var(--panel-border);
            border-radius: 15px;
            background: var(--panel-bg);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            padding: 40px;
        }
        .game-screen { display: none; }
        .game-screen.active {
            display: block;
            animation: fadeIn 1.2s cubic-bezier(0.25, 1, 0.5, 1);
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .game-layout-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
        }
        .column-story, .column-interaction {
            text-align: left;
            background: rgba(0,0,0,0.2);
            padding: 30px;
            border-radius: 10px;
        }
        .column-interaction {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .title-section {
            padding-bottom: 20px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--panel-border);
        }
        .game-title {
            font-family: var(--font-title);
            font-size: 3.5em;
            color: var(--primary-color);
            text-shadow: 0 0 15px var(--primary-color);
        }
        .subtitle {
            font-size: 1.2em;
            color: var(--text-muted);
            font-style: italic;
        }
        .btn, .choice-btn {
            background: linear-gradient(135deg, var(--primary-color), #b42a41);
            color: white; border: none; padding: 15px 35px;
            border-radius: 50px; font-family: var(--font-title);
            font-size: 1.1em; cursor: pointer; transition: all 0.3s ease;
            margin: 10px; box-shadow: 0 4px 15px rgba(233, 69, 96, 0.3);
        }
        .btn:hover, .choice-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 20px rgba(233, 69, 96, 0.5);
        }
        .stats-panel {
            grid-column: 1 / -1;
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 20px; margin-bottom: 10px; border-radius: 10px;
            background: rgba(0,0,0,0.4); border: 1px solid var(--panel-border);
            font-family: var(--font-title); font-size: 1.1em;
        }
        .patient-name {
            font-size: 2.2em; margin-bottom: 20px; color: var(--secondary-color);
        }
        .patient-story {
            font-size: 1.2em; line-height: 1.8;
            max-height: 50vh; overflow-y: auto;
        }
        .memory-jar-container {
            width: 150px; height: 150px; margin: 0 auto 20px auto;
        }
        .memory-jar-container img { max-width: 100%; height: auto; }
        .therapy-input {
            width: 100%; padding: 15px; border-radius: 10px;
            border: 1px solid var(--text-muted); background: rgba(0,0,0,0.7);
            color: white; font-size: 1.1em; font-family: var(--font-body);
            min-height: 130px; resize: vertical;
        }
        .char-counter {
            text-align: right; margin-top: 10px;
            color: var(--text-muted); font-size: 0.9em;
        }
        .choice-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 40px;
        }
        .choice-btn {
            flex: 1;
            padding-top: 25px;
            padding-bottom: 25px;
            font-size: 1.2em;
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--panel-border);
        }
    </style>
</head>
<body>
    <div id="game-wrapper">

        <div id="start-screen" class="game-screen active">
            <div class="container">
                <div class="title-section">
                    <h1 class="game-title">The Memory Therapists</h1>
                    <p class="subtitle">"No bargain without a price."</p>
                </div>
                <div style="padding: 20px; line-height: 1.8; font-size: 1.1em; text-align: left;">
                    <p style="margin-bottom: 15px;">Welcome to the year 2089, the age of Memory Alchemy.</p>
                    <p>You are a Memory Therapist, signing contracts with clients who walk through your door. Your decisions will reshape their past and determine the future of the world. Tread carefully, for here, memory is the soul's most expensive currency.</p>
                </div>
                <button class="btn" onclick="goToChoiceScreen()">Enter the Exchange</button>
            </div>
        </div>

        <div id="choice-screen" class="game-screen">
            <div class="container">
                <div class="title-section">
                    <h2>The First Contract: Foundation of the World</h2>
                </div>
                <p style="font-size: 1.2em; line-height: 1.8;">Every new therapist must first answer one question. Your answer will set the tone for the future of this city:</p>
                <div class="choice-container">
                    <button class="choice-btn" onclick="setWorldFoundation('right')">Memory is<br>a Right</button>
                    <button class="choice-btn" onclick="setWorldFoundation('resource')">Memory is<br>a Resource</button>
                    <button class="choice-btn" onclick="setWorldFoundation('responsibility')">Memory is<br>a Responsibility</button>
                </div>
            </div>
        </div>

        <div id="game-screen" class="game-screen">
            <div class="container" style="padding: 0;">
                 <div class="game-layout-grid">
                    <div class="stats-panel">
                        <div>Year <span id="current-year">1</span></div>
                        <div>Light Points: <span id="light-count" style="color: #ffd700;">0</span> ‚ú¶</div>
                        <div>Target: <span id="year-target">5</span></div>
                    </div>
                    <div class="column-story">
                        <div id="world-atmosphere-text" style="padding: 15px; margin-bottom: 20px; border-radius: 5px; background: rgba(0,0,0,0.2); font-style: italic; color: var(--text-muted);">...</div>
                        <div class="patient-name" id="patient-name"></div>
                        <div class="patient-story" id="patient-story"></div>
                    </div>
                    <div class="column-interaction">
                        <div class="memory-jar-container">
                            <img src="jar.png" alt="A glowing memory jar">
                        </div>
                        <h3 style="margin-bottom: 15px; font-family: var(--font-title);">Contract Details:</h3>
                        <textarea id="therapy-input" class="therapy-input" placeholder="Write the terms of your therapeutic contract here..." maxlength="300"></textarea>
                        <div class="char-counter"><span id="char-count">0</span>/300 Characters</div>
                        <button class="btn" onclick="analyzeTherapy()" id="submit-btn" style="margin-top: 20px; width: 100%;">üñãÔ∏è Sign Contract</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="outcome-screen" class="game-screen">
            <div class="container" id="outcome-container"></div>
        </div>

        <div id="year-end-screen" class="game-screen">
            <div class="container" id="year-end-container"></div>
        </div>

        <div id="end-screen" class="game-screen">
            <div class="container" id="end-container"></div>
        </div>

    </div>

    <script src="memory_exchange_database.js"></script>
    <script>
        let gameState = {
            currentYear: 1, happinessLights: 0, totalPatients: 0,
            decisions: { erase: 0, replace: 0, preserve: 0 },
            yearTargets: [0, 5, 10, 15, 20, 25],
            currentPatient: null, usedPatients: [],
            worldFoundation: null
        };

        function goToChoiceScreen() {
            showScreen('choice-screen');
        }

        function setWorldFoundation(choice) {
            gameState.worldFoundation = choice;
            const foundation = MEMORY_EXCHANGE_DB.worldFoundations[choice];
            
            const atmosphereEl = document.getElementById('world-atmosphere-text');
            if (atmosphereEl) {
                atmosphereEl.textContent = foundation.pawnshop_atmosphere;
            }

            document.body.style.backgroundImage = `linear-gradient(rgba(10, 10, 16, 0.5), rgba(26, 26, 46, 0.5)), url('${foundation.backgroundImageUrl}')`;

            startGame();
        }

        function startGame() {
            showScreen('game-screen');
            generateNewPatient();
        }

        function showScreen(screenId) {
            document.querySelectorAll('.game-screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function generateNewPatient() {
            const PATIENTS_DB = MEMORY_EXCHANGE_DB.patients;
            const availableIds = Object.keys(PATIENTS_DB).filter(id => !gameState.usedPatients.includes(id));
            if (availableIds.length === 0) {
                 gameState.usedPatients = [];
                 availableIds.push(...Object.keys(PATIENTS_DB));
            }
            const id = availableIds[Math.floor(Math.random() * availableIds.length)];
            const patient = PATIENTS_DB[id];
            gameState.currentPatient = { id, ...patient };
            gameState.usedPatients.push(id);
            
            document.getElementById('patient-name').textContent = patient.name;
            document.getElementById('patient-story').textContent = patient.story;
            document.getElementById('current-year').textContent = gameState.currentYear;
            document.getElementById('light-count').textContent = gameState.happinessLights;
            document.getElementById('year-target').textContent = gameState.yearTargets[gameState.currentYear];
            document.getElementById('therapy-input').value = '';
            document.getElementById('char-count').textContent = '0';
        }
        
        async function analyzeTherapy() {
            const input = document.getElementById('therapy-input').value.trim();
            const btn = document.getElementById('submit-btn');
            if (!input) { alert('The contract cannot be empty!'); return; }
            btn.disabled = true; btn.textContent = 'Analyzing Contract...';
            await new Promise(r => setTimeout(r, 1500));

            const analysis = analyzeApproach(input);
            if (analysis.error) {
                alert(analysis.error);
                btn.disabled = false; btn.textContent = 'üñãÔ∏è Sign Contract'; return;
            }
            const lights = computeLights(gameState.currentPatient.id, analysis.primaryApproach, analysis.creativity, analysis.confidence);
            gameState.decisions[analysis.primaryApproach]++;
            gameState.happinessLights += lights;
            gameState.totalPatients++;
            showResults(analysis, input, lights);
            btn.disabled = false; btn.textContent = 'üñãÔ∏è Sign Contract';
        }

        function showResults(analysis, userInput, lights) {
            const container = document.getElementById('outcome-container');
            const DB = MEMORY_EXCHANGE_DB;
            const response = DB.aiResponses[analysis.primaryApproach];
            const pEvo = response.characterEvolutions[gameState.currentPatient.id] || "No specific evolution text.";
            const wImp = response.worldImpacts[gameState.currentPatient.id] || "No specific world impact text.";

            container.innerHTML = `
                <div style="padding: 20px; text-align: left;">
                    <h3 style="font-family: var(--font-title); font-size: 1.5em; margin-bottom: 20px; color: var(--primary-color);">Contract Enacted</h3>
                    <div style="margin-bottom: 25px;">
                        <h4 style="color: var(--primary-color);">AI Analysis</h4>
                        <p style="padding: 10px 0; margin-top: 10px;">${analysis.reasoning}</p>
                    </div>
                    <div style="margin-bottom: 25px;">
                        <h4 style="color: var(--secondary-color);">Patient's Future</h4>
                        <p style="padding: 10px 0; margin-top: 10px;">${pEvo}</p>
                    </div>
                    <div>
                        <h4 style="color: #9d4edd;">Societal Impact</h4>
                        <p style="padding: 10px 0; margin-top: 10px;">${wImp}</p>
                    </div>
                    <div style="text-align: center; margin-top: 30px;">
                        <div style="font-size: 1.2em; color: #ffd700; margin-bottom: 20px;">Light Points +${lights} ‚ú¶</div>
                        <button class="btn" onclick="nextPatient()">Next Client</button>
                    </div>
                </div>
            `;
            showScreen('outcome-screen');
        }

        function nextPatient() {
            if (gameState.totalPatients > 0 && gameState.totalPatients % 3 === 0) { 
                showYearEnd();
            } else {
                generateNewPatient();
                showScreen('game-screen');
            }
        }
        
        function showYearEnd() {
            const container = document.getElementById('year-end-container');
            const target = gameState.yearTargets[gameState.currentYear];
            const survived = gameState.happinessLights >= target;
            container.innerHTML = `
                <div style="padding: 20px;">
                    <h3 style="font-family: var(--font-title); font-size: 1.5em;">Year ${gameState.currentYear} Summary</h3>
                    <div style="margin-top: 20px; line-height: 2;">
                        <p>Yearly Light Points: ${gameState.happinessLights} / ${target}</p>
                        <p style="color: ${survived ? '#4CAF50' : '#ff6b6b'}; font-size: 1.2em; margin-top: 10px;">
                            ${survived ? '‚úÖ Target Reached' : '‚ùå Target Not Reached'}
                        </p>
                        <div style="margin-top: 20px; border-top: 1px solid var(--panel-border); padding-top: 20px;">
                            <p>Yearly Decision Statistics:</p>
                            <div style="margin-left: 20px; opacity: 0.8;">
                                <div>‚Ä¢ Erase: ${gameState.decisions.erase} times</div>
                                <div>‚Ä¢ Replace: ${gameState.decisions.replace} times</div>
                                <div>‚Ä¢ Preserve: ${gameState.decisions.preserve} times</div>
                            </div>
                        </div>
                    </div>
                    <button class="btn" onclick="nextYear()" style="margin-top: 30px;">Proceed to Next Year</button>
                </div>
            `;
            showScreen('year-end-screen');
        }

        function nextYear() {
            gameState.currentYear++;
            if (gameState.currentYear > 5) {
                showGameEnd();
            } else {
                gameState.totalPatients = 0;
                gameState.decisions = { erase: 0, replace: 0, preserve: 0 };
                // We call startGame instead of generateNewPatient to ensure the screen is shown correctly
                startGame();
            }
        }

        function showGameEnd() {
            const container = document.getElementById('end-container');
            const { erase, replace, preserve } = gameState.decisions;
            let majorityChoice = 'preserve';
            if (erase >= replace && erase >= preserve) majorityChoice = 'erase';
            else if (replace >= preserve) majorityChoice = 'replace';

            const endings = MEMORY_EXCHANGE_DB.societalTrends.trendDescriptions;
            const endText = endings[`${majorityChoice}_dominant`] || endings.balanced;


            container.innerHTML = `
                 <div class="title-section">
                    <h2 class="game-title" style="font-size: 2.5em;">The Five-Year Cycle is Complete</h2>
                    <p class="subtitle">The world you created... was it worth it?</p>
                </div>
                <div style="padding: 20px; text-align: left; line-height: 1.8;">
                    <h3 style="color: var(--primary-color); font-family: var(--font-title);">Final World State</h3>
                    <p style="margin: 15px 0; font-size: 1.1em;">${endText}</p>
                    <div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 10px; margin-top: 20px;">
                        <p>Total Light Points: ${gameState.happinessLights}</p>
                        <p style="margin-top: 15px;">Five-Year Therapeutic Tendency:</p>
                        <div style="margin-left: 20px; opacity: 0.8;">
                            <div>Erase: ${erase} times</div>
                            <div>Replace: ${replace} times</div>
                            <div>Preserve: ${preserve} times</div>
                        </div>
                    </div>
                </div>
                <button class="btn" onclick="restartGame()" style="margin-top: 20px;">Restart</button>
            `;
            showScreen('end-screen');
        }

        function restartGame() {
            gameState = {
                currentYear: 1, happinessLights: 0, totalPatients: 0,
                decisions: { erase: 0, replace: 0, preserve: 0 },
                yearTargets: [0, 5, 10, 15, 20, 25],
                currentPatient: null, usedPatients: [],
                worldFoundation: null
            };
            // Reset background to default
            document.body.style.backgroundImage = `linear-gradient(rgba(10, 10, 16, 0.5), rgba(26, 26, 46, 0.5)), url('https://storage.googleapis.com/maker-me/media/images/a51ba200-a35b-4395-8850-62153c9e3831.jpeg')`;
            showScreen('start-screen');
        }

        function analyzeApproach(text) { const DB=MEMORY_EXCHANGE_DB; const input=(text||'').trim(); if(input.length < (DB.security.inputValidation.minLength || 10)) return {error:`Please enter at least ${(DB.security.inputValidation.minLength || 10)} characters`}; const dict=DB.keywordAnalysis||{}; const scores={erase:0,replace:0,preserve:0}; ['erase','replace','preserve'].forEach(b => { const d=dict[b]||{}; (d.primaryKeywords||[]).forEach(k => {if(input.includes(k))scores[b]+=1;}); (d.secondaryKeywords||[]).forEach(k => {if(input.includes(k))scores[b]+=0.5;});}); let p='preserve',max=scores.preserve; Object.entries(scores).forEach(([k,v])=>{if(v>max){max=v;p=k;}}); const reasoning = (DB.aiResponses[p] && DB.aiResponses[p].reasoning) || 'Analysis complete.'; return {primaryApproach:p, creativity:1, confidence:0.8, reasoning: reasoning};}
        function computeLights(id, approach, creativity, confidence){ const TO = MEMORY_EXCHANGE_DB.treatmentOutcomes || {}; const base = (TO.baseLightValues?.[id]?.[approach]) || 2; return base; }

        document.addEventListener('DOMContentLoaded', function() {
            const textarea = document.getElementById('therapy-input');
            const counter = document.getElementById('char-count');
            if (textarea && counter) {
                textarea.addEventListener('input', function() {
                    const len = this.value.length;
                    counter.textContent = len;
                    const p = counter.parentElement;
                    if (len > 280) p.style.color = '#E94560';
                    else if (len > 250) p.style.color = '#feca57';
                    else p.style.color = 'var(--text-muted)';
                });
            }
        });
    </script>
</body>
</html>